app:
  description: 'è´¨æ£€è§„åˆ™ç²¾å‡†åˆ†æå·¥ä½œæµ'
  icon: ğŸ”„
  icon_background: '#E0F2FE'
  mode: workflow
  name: QA Workflow Analyzer
  use_icon_as_answer_icon: false

kind: app
model_config:
  model:
    provider: deepseek
    name: deepseek-chat
    completion_params:
      temperature: 0.2
      max_tokens: 2000
      top_p: 0.9
  
  opening_statement: 'æ‚¨å¥½ï¼Œæˆ‘æ˜¯è´¨æ£€è§„åˆ™åˆ†æåŠ©æ‰‹ã€‚è¯·æä¾›éœ€è¦åˆ†æçš„æ¡ˆä¾‹æ•°æ®ã€‚'
  
  pre_prompt: |
    ä½ æ˜¯è´¨æ£€è§„åˆ™åˆ†æä¸“å®¶ã€‚è¯·åŸºäºæä¾›çš„å…·ä½“å­—æ®µä¿¡æ¯è¿›è¡Œåˆ†æã€‚
    
    æ¡ˆä¾‹ä¿¡æ¯ï¼š
    - è´¨æ£€å•å·ï¼š{{inspection_id}}
    - è¿è§„è§„åˆ™ï¼š{{violation_rule}}
    - è¿è§„å†…å®¹ï¼š{{violation_content}}
    - è¿è§„å•å¥ï¼š{{violation_sentence}}
    - å…¶ä»–è¯­å¥ï¼š{{other_sentences}}
    - äººå·¥å¤‡æ³¨ï¼š{{manual_notes}}
    - åé¦ˆç»“æœï¼š{{feedback_result}}
    - æ¡ˆä¾‹é“¾æ¥ï¼š{{case_link}}
    
    è¯·ä»ä»¥ä¸‹æ–¹é¢è¿›è¡Œåˆ†æï¼š
    1. è§„åˆ™åŒ¹é…åº¦åˆ†æ
       - è¿è§„å†…å®¹ä¸è§„åˆ™çš„å¯¹åº”å…³ç³»
       - è¿è§„å•å¥çš„å…·ä½“è¿è§„ç‚¹
       - å…¶ä»–è¯­å¥çš„ç›¸å…³æ€§
    
    2. äººå·¥åˆ¤æ–­åˆ†æ
       - å¤‡æ³¨é‡ç‚¹å†…å®¹æå–
       - åé¦ˆç»“æœåˆç†æ€§
       - è§„åˆ™é€‚ç”¨å»ºè®®
    
    3. æ”¹è¿›å»ºè®®
       - è§„åˆ™ä¼˜åŒ–æ–¹å‘
       - åˆ¤å®šæ ‡å‡†æ˜ç¡®åŒ–
       - è‡ªåŠ¨åŒ–è¯†åˆ«å¯èƒ½æ€§
    
    4. è§„åˆ™ä¼˜åŒ–
       - è§„åˆ™è¡¨è¿°ä¼˜åŒ–å»ºè®®
       - åˆ¤å®šæ ‡å‡†ç»†åŒ–
       - è‡ªåŠ¨åŒ–è¯†åˆ«æ–¹æ¡ˆ

  user_input_form:
  - text:
      default: ''
      label: 'è´¨æ£€å•å·'
      required: true
      variable: inspection_id
  - text:
      default: ''
      label: 'è¿è§„è§„åˆ™'
      required: true
      variable: violation_rule
  - paragraph:
      default: ''
      label: 'è¿è§„å†…å®¹'
      required: true
      variable: violation_content
  - paragraph:
      default: ''
      label: 'è¿è§„å•å¥'
      required: true
      variable: violation_sentence
  - paragraph:
      default: ''
      label: 'å…¶ä»–è¯­å¥'
      required: false
      variable: other_sentences
  - paragraph:
      default: ''
      label: 'äººå·¥å¤‡æ³¨'
      required: false
      variable: manual_notes
  - text:
      default: ''
      label: 'åé¦ˆç»“æœ'
      required: true
      variable: feedback_result
  - text:
      default: ''
      label: 'æ¡ˆä¾‹é“¾æ¥'
      required: false
      variable: case_link

  retriever_resource:
    enabled: true
    top_k: 30
    rerank: true

workflow:
  graph:
    nodes:
    - data:
        type: start
        title: 'è¡¨æ ¼è¾“å…¥'
        variables:
        - label: 'è¡¨æ ¼æ•°æ®'
          type: paragraph
          required: true
          variable: table_data
      id: 'start'
    
    - data:
        type: code
        title: 'æ•°æ®è§£æ'
        code: |
          import pandas as pd
          import json
          
          # è§£æè¾“å…¥çš„è¡¨æ ¼æ•°æ®ï¼ˆå‡è®¾æ˜¯CSVæ ¼å¼çš„æ–‡æœ¬ï¼‰
          data = pd.read_csv(StringIO(context['start']['table_data']))
          
          # è·å–ç¬¬ä¸€è¡Œæ•°æ®ä½œä¸ºå½“å‰å¤„ç†æ•°æ®
          row = data.iloc[0]
          
          # æ„å»ºè¾“å‡ºå­—å…¸
          result = {
              'inspection_id': str(row['è´¨æ£€å•å·']),
              'violation_rule': str(row['è¿è§„è§„åˆ™']),
              'violation_content': str(row['è¿è§„å†…å®¹']),
              'violation_sentence': str(row['è¿è§„å†…å®¹å¯¹åº”çš„å•å¥']),
              'other_sentences': str(row['å…¶ä½™ç–‘ä¼¼è¯­å¥']),
              'manual_notes': str(row['å¤æ ¸çš„äººå·¥å¤‡æ³¨']),
              'feedback_result': str(row['äººå·¥åé¦ˆçš„ç»“æœ']),
              'case_link': str(row['caseå¯¹åº”çš„é“¾æ¥'])
          }
          
          # è¿”å›JSONæ ¼å¼çš„ç»“æœ
          return json.dumps(result, ensure_ascii=False)
      id: 'parse_data'
    
    - data:
        type: llm
        title: 'è§„åˆ™åˆ†æ'
        model:
          provider: deepseek
          name: deepseek-chat
        prompt_template:
        - role: user
          text: |
            è¯·åˆ†æä»¥ä¸‹è´¨æ£€æ¡ˆä¾‹ï¼š
            
            è´¨æ£€å•å·ï¼š{{#parse_data.inspection_id#}}
            è¿è§„è§„åˆ™ï¼š{{#parse_data.violation_rule#}}
            è¿è§„å†…å®¹ï¼š{{#parse_data.violation_content#}}
            è¿è§„å•å¥ï¼š{{#parse_data.violation_sentence#}}
            å…¶ä»–è¯­å¥ï¼š{{#parse_data.other_sentences#}}
            äººå·¥å¤‡æ³¨ï¼š{{#parse_data.manual_notes#}}
            åé¦ˆç»“æœï¼š{{#parse_data.feedback_result#}}
            æ¡ˆä¾‹é“¾æ¥ï¼š{{#parse_data.case_link#}}
            
            è¯·ä»ä»¥ä¸‹æ–¹é¢è¿›è¡Œåˆ†æï¼š
            1. è§„åˆ™åŒ¹é…åº¦åˆ†æ
            2. äººå·¥åˆ¤æ–­åˆ†æ
            3. æ”¹è¿›å»ºè®®
      id: 'rule_analysis'
    
    - data:
        type: end
        title: 'åˆ†æç»“æœ'
        outputs:
        - value_selector:
          - rule_analysis
          - text
          variable: result
      id: 'end'
    
    edges:
    - source: 'start'
      target: 'parse_data'
      data:
        sourceType: start
        targetType: code
    - source: 'parse_data'
      target: 'rule_analysis'
      data:
        sourceType: code
        targetType: llm
    - source: 'rule_analysis'
      target: 'end'
      data:
        sourceType: llm
        targetType: end

version: 0.1.5